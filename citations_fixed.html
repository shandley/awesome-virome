<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Awesome-Virome Citation Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        :root {
            /* Modern virology-themed color palette */
            --primary-color: #109b81; /* Teal green */
            --primary-light: #6FC3BA;
            --primary-dark: #097362;
            --secondary-color: #2C4B7C; /* Deep blue */
            --secondary-light: #557EBF;
            --secondary-dark: #193152;
            --accent-color: #9D5EB0; /* Purple for viruses */
            --accent-light: #C89AD3;
            --accent-dark: #6A3877;
            --light-bg: #f8f9fa;
            --dark-bg: #1E293B;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --card-shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
            --border-radius: 12px;
            --section-padding: 2rem;
        }
        
        body {
            min-height: 100vh;
            background-color: var(--light-bg);
            color: #333;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            padding-top: 4rem;
        }
        
        [data-theme="dark"] {
            background-color: var(--dark-bg);
            color: #f8f9fa;
        }
        
        /* Navbar styling */
        .navbar {
            background-color: var(--secondary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            height: 4rem;
            z-index: 1030;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white !important;
        }
        
        .navbar-brand span {
            color: var(--primary-light);
        }
        
        .nav-link {
            position: relative;
            padding: 0.5rem 1rem;
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            transition: color var(--transition-speed);
        }
        
        .nav-link:hover {
            color: #ffffff !important;
        }
        
        .nav-link.active {
            color: #ffffff !important;
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1rem;
            right: 1rem;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }
        
        /* Card styling */
        .card {
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: box-shadow var(--transition-speed);
            margin-bottom: 1.5rem;
            border: none;
            height: 100%;
        }
        
        .card:hover {
            box-shadow: var(--card-shadow-hover);
        }
        
        .card-header {
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark));
            color: white;
            font-weight: 600;
            padding: 1rem 1.25rem;
            border-bottom: none;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .section-title {
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
            display: inline-block;
        }
        
        [data-theme="dark"] .section-title {
            color: var(--primary-light);
        }
        
        /* Chart container */
        .chart-container {
            width: 100%;
            height: 300px !important;
            position: relative;
            margin-bottom: 0;
        }
        
        .chart-container-tall {
            width: 100%;
            height: 500px !important;
            position: relative;
            margin-bottom: 0;
        }
        
        /* Loading animation */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            min-height: 300px;
        }
        
        /* Table styling */
        .table th {
            background-color: var(--secondary-light);
            color: white;
            font-weight: 600;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(157, 94, 176, 0.1);
        }
        
        .badge {
            padding: 0.5rem 0.8rem;
            font-weight: 600;
            border-radius: 30px;
        }
        
        /* Theme toggle */
        .theme-toggle {
            cursor: pointer;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.1rem;
            border-radius: 50%;
            transition: background-color var(--transition-speed);
        }
        
        .theme-toggle:hover {
            background-color: rgba(255,255,255, 0.1);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding-top: 4.5rem;
            }
            
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .card-header {
                padding: 0.8rem 1.2rem;
            }
            
            .card-body {
                padding: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">Awesome-<span>Virome</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard_fixed3.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="citations_fixed.html">Citation Analytics</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="theme-toggle me-3" id="theme-toggle">
                        <i class="bi bi-moon-fill"></i>
                    </div>
                    <a href="https://github.com/shandley/awesome-virome" class="btn btn-outline-light" target="_blank">
                        <i class="bi bi-github me-1"></i> GitHub
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container py-5">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-5 fw-bold mb-3">Citation Analytics</h1>
                <p class="lead mb-4">Explore the academic impact and citation metrics of viral bioinformatics tools</p>
            </div>
        </div>
        
        <!-- Citation Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="section-title">Citation Summary</h2>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h3 class="h5">Total Citations</h3>
                        <div class="display-4 fw-bold mb-3" id="totalCitationsCount">...</div>
                        <p class="text-muted">Across all tools in the repository</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h3 class="h5">Average Citations</h3>
                        <div class="display-4 fw-bold mb-3" id="avgCitationsCount">...</div>
                        <p class="text-muted">Per tool with citation data</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h3 class="h5">Most Cited Tool</h3>
                        <div class="h2 fw-bold mb-3" id="topCitedToolName">...</div>
                        <p class="text-muted">With <span id="topCitedToolCount">...</span> citations</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Citation Charts -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="section-title">Citation Analytics</h2>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">Top 5 Most Cited Tools</div>
                    <div class="card-body p-0">
                        <!-- Fixed dimensions for the container and canvas to avoid layout shifts -->
                        <div style="height: 400px; padding: 20px;">
                            <canvas id="topCitedChart" style="width: 100%; height: 360px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">Citation Growth by Year</div>
                    <div class="card-body p-0">
                        <!-- Fixed dimensions for the container and canvas to avoid layout shifts -->
                        <div style="height: 400px; padding: 20px;">
                            <canvas id="citationGrowthChart" style="width: 100%; height: 360px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">Citation Impact Timeline</div>
                    <div class="card-body p-0">
                        <!-- Fixed dimensions for the container and canvas to avoid layout shifts -->
                        <div style="height: 400px; padding: 20px;">
                            <canvas id="citationTimelineChart" style="width: 100%; height: 360px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">Citation Impact by Category</div>
                    <div class="card-body p-0">
                        <!-- Fixed dimensions for the container and canvas to avoid layout shifts -->
                        <div style="height: 400px; padding: 20px;">
                            <canvas id="citationCategoryChart" style="width: 100%; height: 360px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header">Citation Trends for Top Tools</div>
                    <div class="card-body p-0">
                        <!-- Fixed dimensions for the container and canvas to avoid layout shifts -->
                        <div style="height: 500px; padding: 20px;">
                            <canvas id="citationTrendsChart" style="width: 100%; height: 460px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Citation Table -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="section-title">All Tools with Citations</h2>
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover" id="citationTable">
                                <thead>
                                    <tr>
                                        <th>Tool</th>
                                        <th>Total Citations</th>
                                        <th>Influential Citations</th>
                                        <th>First Cited</th>
                                        <th>Recent Growth</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="citationTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="py-5">
                                                <div class="spinner-border text-primary mb-3" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p>Loading citation data...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-center text-white py-4">
        <div class="container">
            <p class="mb-1">Awesome-Virome: A curated collection of virology bioinformatics tools and resources</p>
            <p class="small text-muted mb-0">Data last updated: <span id="lastUpdated">-</span></p>
        </div>
    </footer>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- Main Script -->
    <script>
        // Set chart dimensions and options
        Chart.defaults.animation = false;
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.responsive = true;
        Chart.defaults.font.family = "'Inter', 'system-ui', 'sans-serif'";
        Chart.defaults.font.size = 12;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Citation dashboard initializing...');
            
            // Theme handling
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            
            // Check for saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);
            }
            
            // Toggle theme
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.body.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                
                // Redraw charts if needed
                Object.values(charts).forEach(chart => {
                    if (chart && chart.update) {
                        chart.update();
                    }
                });
            });
            
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.className = 'bi bi-sun-fill';
                } else {
                    themeIcon.className = 'bi bi-moon-fill';
                }
            }
            
            // Load citation data
            loadCitationData();
            
            // Store chart instances
            const charts = {};
            
            // Load and process citation data
            async function loadCitationData() {
                try {
                    // Use absolute URLs for data fetch to avoid path issues
                    const baseUrl = window.location.href.split('/').slice(0, -1).join('/') + '/';
                    const url = new URL('impact_data.json', baseUrl).href;
                    console.log('Fetching impact data from:', url);
                    
                    // Use cache-busting to ensure we get fresh data
                    const response = await fetch(`${url}?t=${Date.now()}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load data (Status: ${response.status})`);
                    }
                    
                    const data = await response.json();
                    console.log('Citation data loaded successfully');
                    
                    // Process citation data
                    processCitationData(data);
                } catch (error) {
                    console.error('Error loading citation data:', error);
                    document.getElementById('citationTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="alert alert-danger my-3">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    Error loading citation data: ${error.message}
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
            
            // Process citation data
            function processCitationData(data) {
                console.log('Processing citation data...');
                
                // Ensure we have tools array
                if (!data.tools || !Array.isArray(data.tools)) {
                    console.error('Invalid data format: tools array missing');
                    return;
                }
                
                // Extract citation information from tools
                const toolsWithCitations = data.tools
                    .map(tool => {
                        // Calculate total citations
                        let totalCitations = 0;
                        const citationsByYear = {};
                        
                        if (tool.citations_by_year) {
                            // Copy citation data to new object
                            Object.entries(tool.citations_by_year).forEach(([year, count]) => {
                                const numCount = Number(count);
                                if (!isNaN(numCount)) {
                                    totalCitations += numCount;
                                    citationsByYear[year] = numCount;
                                }
                            });
                        }
                        
                        // Get years for determining first/last cited
                        const years = Object.keys(citationsByYear).map(Number).sort();
                        
                        // Calculate growth rate (last 2 years vs previous 2 years)
                        let recentGrowth = 'N/A';
                        if (years.length >= 4) {
                            const sortedYears = [...years].sort((a, b) => b - a); // Descending
                            const recent = sortedYears.slice(0, 2)
                                .reduce((sum, year) => sum + citationsByYear[year], 0);
                            const previous = sortedYears.slice(2, 4)
                                .reduce((sum, year) => sum + citationsByYear[year], 0);
                            
                            if (previous > 0) {
                                recentGrowth = ((recent - previous) / previous * 100).toFixed(1) + '%';
                            }
                        }
                        
                        return {
                            name: tool.name,
                            totalCitations: totalCitations,
                            citationsByYear: citationsByYear,
                            years: years,
                            firstCited: years.length > 0 ? Math.min(...years) : null,
                            lastCited: years.length > 0 ? Math.max(...years) : null,
                            influentialCitations: tool.influential_citations || Math.round(totalCitations * 0.2),
                            recentGrowth: recentGrowth,
                            category: tool.category || 'Uncategorized'
                        };
                    })
                    .filter(tool => tool.totalCitations > 0)
                    .sort((a, b) => b.totalCitations - a.totalCitations);
                
                console.log(`Found ${toolsWithCitations.length} tools with citation data`);
                
                // Update citation metrics
                updateCitationMetrics(toolsWithCitations);
                
                // Create citation charts
                createCitationCharts(toolsWithCitations);
                
                // Populate citation table
                populateCitationTable(toolsWithCitations);
                
                // Update last updated date
                document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString();
            }
            
            // Update citation metrics display
            function updateCitationMetrics(toolsWithCitations) {
                // Calculate total citations
                const totalCitations = toolsWithCitations.reduce((sum, tool) => sum + tool.totalCitations, 0);
                document.getElementById('totalCitationsCount').textContent = totalCitations.toLocaleString();
                
                // Calculate average citations
                const avgCitations = toolsWithCitations.length > 0 ? 
                    (totalCitations / toolsWithCitations.length).toFixed(1) : '0';
                document.getElementById('avgCitationsCount').textContent = avgCitations;
                
                // Get top cited tool
                if (toolsWithCitations.length > 0) {
                    const topTool = toolsWithCitations[0];
                    document.getElementById('topCitedToolName').textContent = topTool.name;
                    document.getElementById('topCitedToolCount').textContent = topTool.totalCitations.toLocaleString();
                } else {
                    document.getElementById('topCitedToolName').textContent = 'N/A';
                    document.getElementById('topCitedToolCount').textContent = '0';
                }
            }
            
            // Create citation charts
            function createCitationCharts(toolsWithCitations) {
                createTopCitedChart(toolsWithCitations);
                createCitationGrowthChart(toolsWithCitations);
                createCitationTrendsChart(toolsWithCitations);
                createCitationTimelineChart(toolsWithCitations);
                createCitationCategoryChart(toolsWithCitations);
            }
            
            // Create top cited tools chart
            function createTopCitedChart(toolsWithCitations) {
                const ctx = document.getElementById('topCitedChart').getContext('2d');
                
                // Get top 5 tools for display
                const topTools = toolsWithCitations.slice(0, 5);
                
                charts.topCited = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topTools.map(tool => tool.name),
                        datasets: [{
                            label: 'Total Citations',
                            data: topTools.map(tool => tool.totalCitations),
                            backgroundColor: [
                                '#9D5EB0', // Purple
                                '#557EBF', // Blue
                                '#6FC3BA', // Teal
                                '#7986CB', // Indigo
                                '#4DB6AC'  // Teal/green
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Total Citations'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            datalabels: {
                                align: 'end',
                                anchor: 'end'
                            }
                        }
                    }
                });
            }
            
            // Create citation growth chart
            function createCitationGrowthChart(toolsWithCitations) {
                const ctx = document.getElementById('citationGrowthChart').getContext('2d');
                
                // Get all years from all tools
                const allYears = new Set();
                toolsWithCitations.forEach(tool => {
                    Object.keys(tool.citationsByYear).forEach(year => {
                        allYears.add(parseInt(year));
                    });
                });
                
                // Sort years
                const sortedYears = Array.from(allYears).sort();
                
                // Calculate citations per year
                const citationsByYear = {};
                sortedYears.forEach(year => {
                    citationsByYear[year] = 0;
                });
                
                toolsWithCitations.forEach(tool => {
                    Object.entries(tool.citationsByYear).forEach(([year, count]) => {
                        citationsByYear[year] = (citationsByYear[year] || 0) + count;
                    });
                });
                
                // Calculate cumulative total
                let cumulative = 0;
                const cumulativeData = sortedYears.map(year => {
                    cumulative += citationsByYear[year];
                    return cumulative;
                });
                
                charts.growth = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedYears,
                        datasets: [
                            {
                                label: 'Citations per Year',
                                data: sortedYears.map(year => citationsByYear[year]),
                                backgroundColor: 'rgba(157, 94, 176, 0.2)',
                                borderColor: '#9D5EB0',
                                borderWidth: 2,
                                type: 'bar',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Cumulative Citations',
                                data: cumulativeData,
                                backgroundColor: 'rgba(44, 75, 124, 0.1)',
                                borderColor: '#2C4B7C',
                                borderWidth: 2,
                                fill: false,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Annual Citations'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false
                                },
                                title: {
                                    display: true,
                                    text: 'Total Citations'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }
            
            // Create citation trends chart for top tools
            function createCitationTrendsChart(toolsWithCitations) {
                const ctx = document.getElementById('citationTrendsChart').getContext('2d');
                
                // Get top 5 tools
                const topTools = toolsWithCitations.slice(0, 5);
                
                // Get all years from these tools
                const allYears = new Set();
                topTools.forEach(tool => {
                    Object.keys(tool.citationsByYear).forEach(year => {
                        allYears.add(parseInt(year));
                    });
                });
                
                // Sort years
                const sortedYears = Array.from(allYears).sort();
                
                // Create datasets for each tool
                const datasets = topTools.map((tool, index) => {
                    // Generate colors based on index
                    const hue = (index * 70) % 360;
                    const color = `hsl(${hue}, 70%, 50%)`;
                    
                    return {
                        label: tool.name,
                        data: sortedYears.map(year => tool.citationsByYear[year] || 0),
                        borderColor: color,
                        backgroundColor: `hsla(${hue}, 70%, 50%, 0.1)`,
                        borderWidth: 2,
                        fill: false
                    };
                });
                
                charts.trends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedYears,
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Citations'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            }
            
            // Create citation impact timeline chart
            function createCitationTimelineChart(toolsWithCitations) {
                const ctx = document.getElementById('citationTimelineChart').getContext('2d');
                
                // Filter tools with sufficient citation history (at least 3 years)
                const filteredTools = toolsWithCitations.filter(tool => 
                    Object.keys(tool.citationsByYear).length >= 3
                );
                
                // Get top 5 most impactful tools based on citation growth
                const impactfulTools = [...filteredTools]
                    .sort((a, b) => {
                        // Calculate citation growth rate
                        const aYears = Object.keys(a.citationsByYear).map(Number).sort();
                        const bYears = Object.keys(b.citationsByYear).map(Number).sort();
                        
                        if (aYears.length < 2 || bYears.length < 2) return 0;
                        
                        const aEarliest = Math.min(...aYears);
                        const aLatest = Math.max(...aYears);
                        const aGrowth = a.citationsByYear[aLatest] / a.citationsByYear[aEarliest];
                        
                        const bEarliest = Math.min(...bYears);
                        const bLatest = Math.max(...bYears);
                        const bGrowth = b.citationsByYear[bLatest] / b.citationsByYear[bEarliest];
                        
                        return bGrowth - aGrowth;
                    })
                    .slice(0, 5);
                
                // Get all years from these tools
                const allYears = new Set();
                impactfulTools.forEach(tool => {
                    Object.keys(tool.citationsByYear).forEach(year => {
                        allYears.add(parseInt(year));
                    });
                });
                
                // Sort years
                const sortedYears = Array.from(allYears).sort();
                
                // Create datasets for cumulative citations
                const datasets = impactfulTools.map((tool, index) => {
                    // Generate colors based on index
                    const hue = (index * 70 + 30) % 360; // Different hue range from the trends chart
                    const color = `hsl(${hue}, 70%, 50%)`;
                    
                    // Calculate cumulative data
                    let cumulative = 0;
                    const cumulativeData = sortedYears.map(year => {
                        cumulative += (tool.citationsByYear[year] || 0);
                        return cumulative;
                    });
                    
                    return {
                        label: tool.name,
                        data: cumulativeData,
                        borderColor: color,
                        backgroundColor: `hsla(${hue}, 70%, 50%, 0.1)`,
                        borderWidth: 2,
                        fill: false
                    };
                });
                
                charts.timeline = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedYears,
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cumulative Citations'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Year'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            },
                            title: {
                                display: true,
                                text: 'Cumulative Citation Growth for High-Impact Tools'
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            }
            
            // Create citation impact by category chart
            function createCitationCategoryChart(toolsWithCitations) {
                const ctx = document.getElementById('citationCategoryChart').getContext('2d');
                
                // Use a try/catch block to handle potential data loading errors
                try {
                    // Load categories from data.json with proper URL construction
                    const baseUrl = window.location.href.split('/').slice(0, -1).join('/') + '/';
                    const dataJsonUrl = new URL('data.json', baseUrl).href;
                    console.log("Fetching category data from:", dataJsonUrl);
                    
                    fetch(dataJsonUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Failed to load data.json (Status: ${response.status})`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Category data loaded successfully");
                            
                            // Extract categories and create category lookup map
                            const categoryNodes = data.nodes.filter(node => node.type === 'category');
                            const toolNodes = data.nodes.filter(node => node.type === 'tool');
                            
                            // Create a map of tool names to their categories
                            const toolCategoryMap = {};
                            
                            // Process links to map tools to categories
                            data.links.forEach(link => {
                                if (link.source && link.target) {
                                    // Find the nodes
                                    const sourceNode = data.nodes.find(node => node.id === link.source);
                                    const targetNode = data.nodes.find(node => node.id === link.target);
                                    
                                    // If this is a tool-to-category link
                                    if (sourceNode && targetNode && 
                                        (sourceNode.type === 'tool' && targetNode.type === 'category')) {
                                        toolCategoryMap[sourceNode.name] = targetNode.name;
                                    }
                                    
                                    // Tool to subcategory link (we need to find the parent category)
                                    if (sourceNode && targetNode && 
                                        (sourceNode.type === 'tool' && targetNode.type === 'subcategory')) {
                                        // Find the parent category of this subcategory
                                        const parentCategoryName = targetNode.parent;
                                        if (parentCategoryName) {
                                            toolCategoryMap[sourceNode.name] = parentCategoryName;
                                        }
                                    }
                                }
                            });
                            
                            // Define our main categories
                            const mainCategories = [
                                "Virus and Phage Identification",
                                "Genome Analysis",
                                "Host Prediction",
                                "Sequence Analysis",
                                "Taxonomy",
                                "Functional Analysis",
                                "CRISPR Analysis",
                                "Databases"
                            ];
                            
                            // Initialize category data with predefined categories
                            const categoryData = {};
                            mainCategories.forEach(category => {
                                categoryData[category] = {
                                    totalCitations: 0,
                                    toolCount: 0,
                                    tools: [],
                                    color: categoryNodes.find(node => node.name === category)?.color || '#343a40'
                                };
                            });
                            
                            // Add "Other" category
                            categoryData["Other"] = {
                                totalCitations: 0,
                                toolCount: 0,
                                tools: [],
                                color: '#6c757d'
                            };
                            
                            // Populate data for each tool
                            toolsWithCitations.forEach(tool => {
                                // Try to find the tool's category
                                let category = toolCategoryMap[tool.name];
                                
                                // If no category found, use fuzzy matching for the tool name
                                if (!category) {
                                    // Try to find the node with a similar name
                                    const toolNode = toolNodes.find(node => 
                                        node.name.toLowerCase() === tool.name.toLowerCase());
                                    if (toolNode) {
                                        const toolLinks = data.links.filter(link => link.source === toolNode.id);
                                        for (const link of toolLinks) {
                                            const targetNode = data.nodes.find(node => node.id === link.target);
                                            if (targetNode && (targetNode.type === 'category' || targetNode.type === 'subcategory')) {
                                                category = targetNode.type === 'category' ? 
                                                    targetNode.name : targetNode.parent;
                                                break;
                                            }
                                        }
                                    }
                                }
                                
                                // Check if the found category is in our main categories
                                if (!category || !mainCategories.includes(category)) {
                                    category = "Other";
                                }
                                
                                // Initialize category if needed (should not be needed for predefined categories)
                                if (!categoryData[category]) {
                                    categoryData[category] = {
                                        totalCitations: 0,
                                        toolCount: 0,
                                        tools: [],
                                        color: '#6c757d' // Default gray for any unexpected categories
                                    };
                                }
                                
                                // Update category data
                                categoryData[category].totalCitations += tool.totalCitations;
                                categoryData[category].toolCount += 1;
                                categoryData[category].tools.push({
                                    name: tool.name,
                                    citations: tool.totalCitations
                                });
                            });
                            
                            // Sort tools within each category
                            Object.keys(categoryData).forEach(category => {
                                // Sort tools by citations
                                categoryData[category].tools.sort((a, b) => b.citations - a.citations);
                            });
                            
                            // Filter out categories with no tools
                            const filteredCategories = Object.entries(categoryData)
                                .filter(([_, data]) => data.toolCount > 0)
                                .sort((a, b) => b[1].totalCitations - a[1].totalCitations);
                            
                            // Prepare data for Chart.js
                            const categories = filteredCategories.map(([cat]) => cat);
                            const totalCitations = filteredCategories.map(([_, data]) => data.totalCitations);
                            const toolsPerCategory = filteredCategories.map(([_, data]) => data.toolCount);
                            const categoryColors = filteredCategories.map(([_, data]) => data.color || '#6c757d');
                            
                            // Create the chart
                            charts.category = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: categories,
                                    datasets: [
                                        {
                                            label: 'Citations',
                                            data: totalCitations,
                                            backgroundColor: categoryColors.map(color => `${color}cc`), // Add transparency
                                            borderColor: categoryColors,
                                            borderWidth: 1
                                        }
                                    ]
                                },
                                options: {
                                    indexAxis: 'y',  // Horizontal bar chart for better readability
                                    scales: {
                                        x: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Citations',
                                                font: {
                                                    weight: 'bold',
                                                    size: 14
                                                }
                                            },
                                            ticks: {
                                                color: 'rgba(44, 75, 124, 1)',
                                                font: {
                                                    weight: 'bold'
                                                }
                                            }
                                        },
                                        y: {
                                            title: {
                                                display: true,
                                                text: 'Category',
                                                font: {
                                                    weight: 'bold',
                                                    size: 14
                                                }
                                            },
                                            ticks: {
                                                // Make category labels more readable
                                                font: {
                                                    size: 13,
                                                    weight: 'bold'
                                                },
                                                color: 'rgba(44, 75, 124, 1)'
                                            }
                                        }
                                    },
                                    plugins: {
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            titleFont: {
                                                weight: 'bold',
                                                size: 14
                                            },
                                            bodyFont: {
                                                size: 13
                                            },
                                            padding: 10,
                                            callbacks: {
                                                afterTitle: function(context) {
                                                    const categoryIndex = context[0].dataIndex;
                                                    const toolCount = toolsPerCategory[categoryIndex];
                                                    return [
                                                        `${toolCount} tools in this category`
                                                    ];
                                                },
                                                afterBody: function(context) {
                                                    const categoryIndex = context[0].dataIndex;
                                                    const category = categories[categoryIndex];
                                                    const categoryInfo = filteredCategories.find(([cat]) => cat === category)[1];
                                                    const topTools = categoryInfo.tools.slice(0, 5);
                                                    
                                                    return [
                                                        '',
                                                        'Top tools in this category:',
                                                        ...topTools.map(tool => `${tool.name}: ${tool.citations} citations`)
                                                    ];
                                                }
                                            }
                                        },
                                        title: {
                                            display: true,
                                            text: 'Citation Impact by Category',
                                            font: {
                                                size: 16,
                                                weight: 'bold'
                                            },
                                            padding: {
                                                top: 10,
                                                bottom: 20
                                            }
                                        },
                                        legend: {
                                            display: false
                                        },
                                        // Add dataset labels directly on chart
                                        datalabels: {
                                            display: true,
                                            color: 'white',
                                            align: 'center',
                                            anchor: 'center',
                                            font: {
                                                weight: 'bold'
                                            },
                                            formatter: function(value) {
                                                return value > 0 ? value.toLocaleString() : '';
                                            }
                                        }
                                    }
                                }
                            });
                        })
                        .catch(error => {
                            console.error('Error loading category data:', error);
                            
                            // Fallback to the original implementation if data.json cannot be loaded
                            createFallbackCategoryChart(toolsWithCitations, ctx);
                        });
                } catch (error) {
                    console.error('Error initializing category chart:', error);
                    createFallbackCategoryChart(toolsWithCitations, ctx);
                }
            }
            
            // Fallback implementation if data.json cannot be loaded
            function createFallbackCategoryChart(toolsWithCitations, ctx) {
                console.log('Using fallback category chart implementation');
                // Group tools by category
                const categoryData = {};
                
                toolsWithCitations.forEach(tool => {
                    // Handle case where category is missing or 'Uncategorized'
                    const category = (tool.category && tool.category !== 'Uncategorized') 
                        ? tool.category 
                        : 'Other';
                    
                    // Initialize category if not exists
                    if (!categoryData[category]) {
                        categoryData[category] = {
                            totalCitations: 0,
                            toolCount: 0,
                            tools: []
                        };
                    }
                    
                    // Update category data
                    categoryData[category].totalCitations += tool.totalCitations;
                    categoryData[category].toolCount += 1;
                    categoryData[category].tools.push({
                        name: tool.name,
                        citations: tool.totalCitations
                    });
                });
                
                // Sort tools within each category by citations
                Object.keys(categoryData).forEach(category => {
                    categoryData[category].tools.sort((a, b) => b.citations - a.citations);
                });
                
                // Sort categories by total citation impact and filter those with at least 3 tools
                const sortedCategories = Object.entries(categoryData)
                    .filter(([, data]) => data.toolCount >= 3) // Only include categories with at least 3 tools
                    .sort((a, b) => b[1].totalCitations - a[1].totalCitations)
                    .slice(0, 6); // Limit to top 6 categories for readability
                
                // If we have fewer than 2 categories after filtering, include some with fewer tools
                if (sortedCategories.length < 2) {
                    const additionalCategories = Object.entries(categoryData)
                        .filter(([, data]) => data.toolCount < 3)
                        .sort((a, b) => b[1].totalCitations - a[1].totalCitations)
                        .slice(0, 6 - sortedCategories.length);
                    
                    sortedCategories.push(...additionalCategories);
                }
                
                const categories = sortedCategories.map(([cat]) => cat);
                const totalCitations = sortedCategories.map(([, data]) => data.totalCitations);
                const toolsPerCategory = sortedCategories.map(([, data]) => data.toolCount);
                
                // Create datasets for visualization
                charts.category = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: categories,
                        datasets: [
                            {
                                label: 'Citations',
                                data: totalCitations,
                                backgroundColor: 'rgba(157, 94, 176, 0.7)',
                                borderColor: 'rgba(157, 94, 176, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y',  // Horizontal bar chart for better readability
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Citations',
                                    font: {
                                        weight: 'bold',
                                        size: 14
                                    }
                                },
                                ticks: {
                                    color: 'rgba(44, 75, 124, 1)',
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Category',
                                    font: {
                                        weight: 'bold',
                                        size: 14
                                    }
                                },
                                ticks: {
                                    // Make category labels more readable
                                    font: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    color: 'rgba(44, 75, 124, 1)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                titleFont: {
                                    weight: 'bold',
                                    size: 14
                                },
                                bodyFont: {
                                    size: 13
                                },
                                padding: 10,
                                callbacks: {
                                    afterTitle: function(context) {
                                        const categoryIndex = context[0].dataIndex;
                                        const toolCount = toolsPerCategory[categoryIndex];
                                        return [
                                            `${toolCount} tools in this category`
                                        ];
                                    },
                                    afterBody: function(context) {
                                        const categoryIndex = context[0].dataIndex;
                                        const category = categories[categoryIndex];
                                        const topTools = categoryData[category].tools.slice(0, 3);
                                        
                                        return [
                                            '',
                                            'Top tools in this category:',
                                            ...topTools.map(tool => `${tool.name}: ${tool.citations} citations`)
                                        ];
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Citation Impact by Category',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 20
                                }
                            },
                            legend: {
                                display: false
                            },
                            // Add dataset labels directly on chart
                            datalabels: {
                                display: true,
                                color: 'white',
                                align: 'center',
                                anchor: 'center',
                                font: {
                                    weight: 'bold'
                                },
                                formatter: function(value) {
                                    return value > 0 ? value.toLocaleString() : '';
                                }
                            }
                        }
                    }
                });
            }
            
            // Populate citation table
            function populateCitationTable(toolsWithCitations) {
                const tableBody = document.getElementById('citationTableBody');
                
                // Clear existing content
                tableBody.innerHTML = '';
                
                // Create row for each tool
                toolsWithCitations.forEach(tool => {
                    const row = document.createElement('tr');
                    
                    // Create mini trend sparkline
                    const trendSvg = createSparkline(tool.citationsByYear);
                    
                    // Add growth indicator
                    let growthIndicator = tool.recentGrowth;
                    if (tool.recentGrowth !== 'N/A') {
                        const growthValue = parseFloat(tool.recentGrowth);
                        if (growthValue > 0) {
                            growthIndicator = `<span class="text-success"><i class="bi bi-arrow-up-right"></i> ${tool.recentGrowth}</span>`;
                        } else if (growthValue < 0) {
                            growthIndicator = `<span class="text-danger"><i class="bi bi-arrow-down-right"></i> ${tool.recentGrowth}</span>`;
                        }
                    }
                    
                    // Create table row
                    row.innerHTML = `
                        <td><strong>${tool.name}</strong></td>
                        <td>${tool.totalCitations.toLocaleString()}</td>
                        <td>${tool.influentialCitations.toLocaleString()}</td>
                        <td>${tool.firstCited || 'N/A'}</td>
                        <td>${growthIndicator}</td>
                        <td>${trendSvg}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Initialize DataTable
                $('#citationTable').DataTable({
                    pageLength: 25,
                    order: [[1, 'desc']], // Sort by total citations
                    language: {
                        search: "Search tools:"
                    }
                });
            }
            
            // Create a sparkline SVG from yearly citation data
            function createSparkline(citationsByYear) {
                if (!citationsByYear || Object.keys(citationsByYear).length === 0) {
                    return '<span class="text-muted">No data</span>';
                }
                
                // Get years and citation counts
                const years = Object.keys(citationsByYear).sort();
                const values = years.map(year => citationsByYear[year]);
                
                // Set dimensions
                const width = 100;
                const height = 30;
                const padding = 2;
                
                // Find min and max values
                const maxValue = Math.max(...values);
                
                // Create SVG element
                let svg = `<svg width="${width}" height="${height}" style="vertical-align: middle;">`;
                
                // Calculate bar width based on number of years
                const barWidth = Math.max(2, (width - (2 * padding)) / years.length - 1);
                
                // Draw bars
                years.forEach((year, i) => {
                    const value = citationsByYear[year];
                    const barHeight = maxValue > 0 ? (value / maxValue) * (height - (2 * padding)) : 0;
                    const x = padding + i * (barWidth + 1);
                    const y = height - padding - barHeight;
                    
                    // Use color based on recency
                    const currentYear = new Date().getFullYear();
                    const yearDiff = currentYear - parseInt(year);
                    let color;
                    if (yearDiff <= 2) {
                        color = '#9D5EB0'; // Recent - purple
                    } else if (yearDiff <= 4) {
                        color = '#557EBF'; // Medium - blue
                    } else {
                        color = '#6FC3BA'; // Older - teal
                    }
                    
                    svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" />`;
                });
                
                svg += '</svg>';
                return svg;
            }
        });
    </script>
</body>
</html>