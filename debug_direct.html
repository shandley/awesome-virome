<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Citation Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Direct Citation Count Comparison</h1>
    <p>This page directly calculates citation counts from the impact_data.json file.</p>
    
    <div id="loading">Loading...</div>
    <div id="result" style="display:none;">
        <h2>Results</h2>
        <table id="resultTable">
            <thead>
                <tr>
                    <th>Tool</th>
                    <th>Citations by Year</th>
                    <th>Total Calculated</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be populated here -->
            </tbody>
        </table>
        
        <h2>Raw Data</h2>
        <pre id="raw"></pre>
    </div>
    
    <script>
        // Direct calculation function - will check each tool
        function calculateCitations(tool) {
            // Check if tool has citations_by_year
            if (!tool.citations_by_year || typeof tool.citations_by_year !== 'object') {
                return {
                    name: tool.name,
                    citationsYearly: {},
                    total: 0,
                    error: "No citations_by_year data"
                };
            }
            
            // Calculate sum directly
            let total = 0;
            const yearlyData = {};
            
            // Sum each year's citations
            Object.entries(tool.citations_by_year).forEach(([year, count]) => {
                const numCount = Number(count);
                if (!isNaN(numCount)) {
                    total += numCount;
                    yearlyData[year] = numCount;
                }
            });
            
            return {
                name: tool.name,
                citationsYearly: yearlyData,
                total: total,
                error: null
            };
        }
        
        // Directly check QuRe and VirSorter-DarkMatter
        fetch('impact_data.json')
            .then(response => response.json())
            .then(data => {
                // Get references to our elements
                const loadingElem = document.getElementById('loading');
                const resultElem = document.getElementById('result');
                const resultTable = document.getElementById('resultTable').querySelector('tbody');
                const rawElem = document.getElementById('raw');
                
                // Hide loading, show results
                loadingElem.style.display = 'none';
                resultElem.style.display = 'block';
                
                // Extract just the tools array for clarity
                const tools = data.tools || [];
                
                // Find QuRe and VirSorter-DarkMatter
                let quRe = tools.find(tool => tool.name === 'QuRe');
                let virSorterDM = tools.find(tool => tool.name === 'VirSorter-DarkMatter');
                
                // Calculate totals
                const results = [
                    quRe && calculateCitations(quRe),
                    virSorterDM && calculateCitations(virSorterDM)
                ].filter(Boolean);
                
                // Sort by total citations
                results.sort((a, b) => b.total - a.total);
                
                // Add the top 15 tools by citation
                const topTools = [...tools]
                    .map(tool => calculateCitations(tool))
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 15);
                
                // Populate results table
                let tableHTML = '';
                
                topTools.forEach(result => {
                    const yearsStr = Object.entries(result.citationsYearly)
                        .map(([year, count]) => `${year}: ${count}`)
                        .join(', ');
                        
                    tableHTML += `
                        <tr>
                            <td>${result.name}</td>
                            <td>${yearsStr}</td>
                            <td>${result.total}</td>
                        </tr>
                    `;
                });
                
                resultTable.innerHTML = tableHTML;
                
                // Show raw data
                rawElem.textContent = JSON.stringify({
                    quRe: quRe,
                    virSorterDM: virSorterDM,
                    quReResult: quRe && calculateCitations(quRe),
                    virSorterDMResult: virSorterDM && calculateCitations(virSorterDM)
                }, null, 2);
            })
            .catch(error => {
                document.getElementById('loading').innerHTML = `
                    <div style="color: red; font-weight: bold;">
                        Error loading data: ${error.message}
                    </div>
                `;
            });
    </script>
</body>
</html>