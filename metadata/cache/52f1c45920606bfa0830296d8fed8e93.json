{
  "cache_date": "2025-03-17T03:33:12.946599",
  "data": "# phamb\nA Phage from metagenomic bins (phamb) discovery approach used to isolate metagenome derived viromes and High-quality viral genomes. phamb is now published in [Nature Communications](https://www.nature.com/articles/s41467-022-28581-5), have a look and let us know if you have any questions.\n\nThe repository contains scripts and workflows used in our viral follow up study on the binning tool [VAMB](https://github.com/RasmussenLab/vamb) where we have benchmarked not only the quality and quantity of viral MAGs but also the viral overlap with metaviromes.\n\nWe have applied this approach to 3 different datasets and recovered up to 6,077 High-quality genomes from 1,024 viral populations, this is 200% more compared to only evaluation single-contigs. Similar to what we have observed for Bacterial bins, VAMB achieves high intra-VAMB-cluster ANI (>97.5%) also for viral bins, our best example here is accurate clustering of crAss-like bins found in the IBD Human Microbiome Project 2 dataset. \n\n- Our (recommended) workflow is to isolate the virome search space prior to running viral evaluation/prediction tools. For this, we have trained a Random Forest model on viral bins established using paired metagenomic and metavirome datasets. This massively helps in reducing computational time especially on larger datasets.\n- We strongly advise to only use Medium-quality and High-quality viral bins evaluated using the AAI-model in CheckV. We found the HMM-model is not currently well-suited for viral MAGs. Low-quality viral bins may likely represent fragmented/incomplete viruses or general contamination, we advice caution with using these. \n\nIn our analysis, [CheckV](https://bitbucket.org/berkeleylab/checkv/src/master/) has been important for assessing the actual gain of using viral MAGs relative to single-contig evaluation, a big kudos to Nayfach et al. for this great tool. \n\n## [Prerequisites & Installation] \n\nIn order to run parallel annotations of contigs and running the Random Forest model you need snakemake and `scikit-learn v. 1.0.2`. The snakemake workflows comes with conda-environments, thus dependencies and programmes are automatically installed. Phamb can now be installed via [bioconda](https://anaconda.org/bioconda/phamb) thanks to @jayramr!\n```bash\n### New dependencies *Recommended*\nconda install -c conda-forge mamba\nmamba create -n phamb python=3.9\nconda activate phamb \nmamba install -c conda-forge -c bioconda snakemake\nmamba install -c conda-forge -c bioconda cython\nmamba install -c conda-forge -c bioconda pygraphviz\nmamba install -c conda-forge -c bioconda phamb\n```\n\n```\n### Clone repository\ngit clone the repository https://github.com/RasmussenLab/phamb.git\n\n### Alternative to bioconda - Quick install with pip\npip install -e .\n\n### Test installation\nmkdir -p testout \nrun_RF.py test/contigs.fna.gz test/clusters.tsv test testout\n```\n\n\n## 1. MAG annotation for isolating Metagenomic derived viromes\n\n### Database and file requirements\nVAMB clusters and concatenated assemblies. \n\n```bash\ncontigs.fna.gz #Concatenated assembly \nvamb/clusters.tsv   #Clustered contigs based on the above contigs.fna.gz file \n```\nFurthermore. \n* [VOGdb](https://vogdb.csb.univie.ac.at/download) - untar `vog.hmm.tar.gz` to get all hmm files. Concatenate all the hmm-files these into an `AllVOG.hmm` file  [File path needs to be specified in `config.yaml`]\n* [Micomplete Bacterial HMMs](https://bitbucket.org/evolegiolab/micomplete/src/master/micomplete/share/Bact105.hmm)   [File path needs to be specified in `config.yaml`]\n* Clone [DeepVirFinder](https://github.com/jessieren/DeepVirFinder) git clone https://github.com/jessieren/DeepVirFinder\n\n### How to Run - Parallel annotation\nCopy the phamb repository, extract the `mag_annotation` workflow and split contigs (using the provided script) to allow annotation to be run in parallel.\nIf you have relatively few contigs or have the patience to annotate all contigs in one batch you can skip the Snakemake part.\n\n```bash\nmkdir -p projectdir \ncd projectdir \ngit clone the repository https://github.com/RasmussenLab/phamb.git\ncp -r phamb/workflows/mag_annotation .\npython split_contigs.py -c contigs.fna.gz \n```\n\n- Now the `contigs.fna.gz` is splitted into individual assemblies i.e. `assembly/{sample}/{sample}.fna`\n- In addition, a `sample_table.txt` file is created with a line for each sample. Check that `sample_table.txt` contains sample identifiers corresponding to the ones you expect. The number of lines should correspond to the number of samples used to make the concatenated assembly (`contigs.fna.gz`).\n- Now, specify paths for databases, vamb directory, location of assembly and computational resources in `mag_annotation/config.yaml`.\n\nIf everything is good and set, you can run the snakemake pipeline.\n```bash\n# Local \nsnakemake -s mag_annotation/Snakefile --use-conda -j <threads>\n\n#Aggregate results\nmkdir annotations\ncat sample_annotation/*/*hmmMiComplete105.tbl > annotations/all.hmmMiComplete105.tbl\ncat sample_annotation/*/*hmmVOG.tbl > annotations/all.hmmVOG.tbl\ncat sample_annotation/*/*_dvf/*dvfpred.txt > annotations/DVF.predictions.txt\n\n# Clean the DVF files for multiple headers.\nhead -n1 annotations/DVF.predictions.txt > DVF.header # get first header\ngrep -v 'pvalue' annotations/DVF.predictions.txt > DVF.predictions # get predictions \ncat DVF.header DVF.predictions > annotations/all.DVF.predictions.txt # combine\n\n```\n\nDependent on the number of samples, it may be relevant to run the Snake-flow on a High performance computing (HPC) server.\n```bash\n# HPC - this won't work unless you specify a legit group on your HPC in `config.yaml`\nsnakemake -s Snakefile --cluster qsub -j <threads> --use-conda\n```\n\n### How to Run - not in parallel - quick and dirty\nMake sure to have Prodigal, hmmer and DeepVirFinder depedencies installed. Check under `mag_annotation/envs` for relevant conda environments. \n```\nmkdir annotations\ngunzip contigs.fna.gz\npython3 /user/DeepVirFinder/dvf.py -i contigs.fna -o DVF -l 2000 -c 1\nmv DVF/contigs.fna_gt2000bp_dvfpred.txt annotations/all.DVF.predictions.txt\nprodigal -i contigs.fna -d genes.fna -a proteins.faa -p meta -g 11\nhmmsearch --cpu {threads} -E 1.0e-05 -o output.txt --tblout annotations/all.hmmMiComplete105.tbl <micompleteDB> proteins.faa\nhmmsearch --cpu {threads} -E 1.0e-05 -o output.txt --tblout annotations/all.hmmVOG.tbl <VOGDB> proteins.faa\ngzip contigs.fna\n```\n\n### Run the RF model\nRunning the provided script, the virome bins are written to a fasta file and bin-annotations are summarised in `vambbins_aggregated_annotation.txt`. \n```bash\nrun_RF.py contigs.fna.gz vamb/clusters.tsv annotations resultdir\n\nls resultsidr\nresultdir/vambbins_aggregated_annotation.txt\nresultdir/vambbins_RF_predictions.txt\nresultsdir/vamb_bins #Concatenated predicted viral bins - writes bins in chunks to files so there might be several! \n```\n \nWe recommend VAMB bins to be evaluated with a dedicated Viral evaluation tool like [CheckV](https://bitbucket.org/berkeleylab/checkv/src/master/) or [VIBRANT](https://github.com/AnantharamanLab/VIBRANT) to identify HQ viruses. \n\n```bash\ncheckv end_to_end resultsdir/vamb_bins/vamb_bins.1.fna checkv_vamb_bins  \n```\n\n\n\n\n### Further information \n\n- The RF model automates filtering of VAMB bins that are most likely bacterial and therefore provides a space of plausible viral entities for further validation. The RF-model has been trained on paired Metaviromes and Metagenomes to make precisde decisions based on simple parameteres as the ones below. Compared to a single contig viral prediction model, the RF approach is very accurate. The increased performance is likely explained by the RF model evaluating on bin-level where one sequence with a low viral score does NOT lead to a misprediction of the whole bin. Aggregated information (assuming the binning is really good!) from multiple-contigs improves prediction compared to single-contigs.\n\nThe RF model take few variables to make an accurate distinction.\n| binsize (bp) | nhallm | distinct_VOGs_factor | cluster_DVF_score |\n|--------------|--------|-------|-------------------|\n| 2.000.000    | 100    | 0.2   | 0.3               |\n| 60.000       | 3      | 1.3   | 0.7               |\n\n\n- Bacterial MAGs and viral MAGs from the same metagenome can be efficiently associated using crispr-spacer approaches and sequence alignment (recommended cutoffs can be found in the article). From this, Host-viral abundance dynamics and bacterial pangenome modulation can be studied. Downstream viral proteome analysis should be based on the `viral regions` found in the `contamination.tsv` file produced by CheckV to prevent contaminating bacterial genes to influence the analysis. \n"
}